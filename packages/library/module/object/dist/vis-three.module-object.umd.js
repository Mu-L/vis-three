(function(u,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("@vis-three/tdcm"),require("@vis-three/utils")):typeof define=="function"&&define.amd?define(["exports","@vis-three/tdcm","@vis-three/utils"],l):(u=typeof globalThis<"u"?globalThis:u||self,l((u["vis-three"]=u["vis-three"]||{},u["vis-three"]["module-object"]={}),u.tdcm,u.utils))})(this,function(u,l,g){"use strict";const O=function(){return Object.assign(l.getBasicConfig(),{type:"Object3D",castShadow:!0,receiveShadow:!0,lookAt:"",visible:!0,raycast:!0,matrixAutoUpdate:!0,renderOrder:0,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},up:{x:0,y:1,z:0},parent:"",children:[],pointerdown:[],pointermove:[],pointerup:[],pointerenter:[],pointerleave:[],click:[],dblclick:[],contextmenu:[]})},L=l.defineRule([function(t){return t.key!=="parent"},l.DEFAULT_RULE.SYMBOL_VALIDATOR,l.DEFAULT_RULE.OPERATE_ADD,l.DEFAULT_RULE.OPERATE_DELETE,l.DEFAULT_RULE.OPERATE_COVER,l.DEFAULT_RULE.OPERATE_COMPILE]),s=class s{static generateConfig(e,r){if(!s.configLibrary.has(e))return console.warn(`event library can not found config by name: ${e}`),null;const n=(o,i)=>{for(const a in i)typeof i[a]=="object"&&i[a]!==null&&!Array.isArray(i[a])?n(o[a],i[a]):o[a]=i[a]},c=JSON.parse(JSON.stringify(s.configLibrary.get(e)));return n(c,r),c}static generateEvent(e,r){return s.generatorLibrary.has(e.name)?s.generatorLibrary.get(e.name)(r,e):(console.error(`event library can not found generator by name: ${e.name}`),()=>{})}static has(e){return s.configLibrary.has(e)}static useEngine(e){s.engine=e}static createEvent(e,r,n){if(!s.engine&&!n)return console.error("EventGenerator Manager createEvent must provide an engine, you can use 'useEngine' to set it."),null;const c=s.generateConfig(e,r);return c?s.generateEvent(c,n||s.engine):null}};s.configLibrary=new Map,s.generatorLibrary=new Map,s.register=function({config:e,generator:r}){return s.configLibrary.has(e.name)?(console.warn(`EventGeneratorManager has already exist this event generator: ${e.name}, that will be cover.`),s):(s.configLibrary.set(e.name,JSON.parse(JSON.stringify(e))),s.generatorLibrary.set(e.name,r),s)};let v=s;const h=function({model:t,target:e,config:r,value:n,engine:c}){if(r.vid===n){console.warn("can not set object lookAt itself.");return}const o=t.cacheLookAt;if(!n){if(!o.updateMatrixWorld)return;e.updateMatrixWorld=o.updateMatrixWorld,o.target=null,o.updateMatrixWorld=null;return}t.toAsync(i=>{const a=c.compilerManager.getObjectFromModules(l.OBJECT_MODULE,n);if(!a)return i&&console.warn(`lookAt handler can not found this vid mapping object: '${n}'`),!1;const y=e.updateMatrixWorld;return o.updateMatrixWorld=y,o.target=a.position,e.updateMatrixWorld=E=>{y.call(e,E),e.lookAt(o.target)},!0})},d=function({model:t,path:e,value:r,engine:n,target:c}){const o=e[0];if(!v.has(r.name)){console.warn(`EventGeneratorManager: can not support this event: ${r.name}`);return}const i=v.generateEvent(r,n),a=Symbol.for(t.eventSymbol);r[a]=i,c.addEventListener(o,i)},f=function({model:t,target:e,path:r,value:n}){const c=r[0],o=n[Symbol.for(t.eventSymbol)];if(!o){console.warn("event remove can not fun found event in config",n);return}e.removeEventListener(c,o),delete n[Symbol.for(t.eventSymbol)]},p=function({model:t,target:e,config:r,path:n,engine:c}){if(n.length<2)return;const o=n[0],i=r[n[0]][n[1]],a=i[Symbol.for(t.eventSymbol)];if(!a){console.warn("event remove can not fun found event in config",i);return}e.removeEventListener(o,a);const y=v.generateEvent(i,c);i[Symbol.for(t.eventSymbol)]=y,e.addEventListener(o,y)},b=function({model:t,target:e,config:r,value:n,engine:c}){t.toTrigger("object",o=>{var y;const i=t.toConfig(n);if(!i)return o||console.warn(` can not foud object config in engine: ${n}`),!1;if(i.parent&&i.parent!==r.vid){const E=t.toConfig(i.parent);if(!E)return o||console.warn(` can not foud object parent config in engine: ${i.parent}`),!1;E.children.splice(E.children.indexOf(n),1)}i.parent=r.vid;const a=c.compilerManager.getObjectFromModules(l.OBJECT_MODULE,n);return a?(e.add(a),a.updateMatrixWorld(!0),(y=t.toModel(n))==null||y.emit(`${l.MODEL_EVENT.COMPILED_ATTR}:parent`),!0):(o||console.warn(`can not found this vid in engine: ${n}.`),!1)})},M=function({model:t,target:e,config:r,value:n,engine:c}){var a;const o=c.compilerManager.getObjectFromModules(l.OBJECT_MODULE,n);if(!o){console.warn(`can not found this vid in engine: ${n}.`);return}e.remove(o);const i=c.getConfigBySymbol(n);if(!i){console.warn(`can not found this vid in engine: ${n}.`);return}i.parent="",(a=t.toModel(n))==null||a.emit(`${l.MODEL_EVENT.COMPILED_ATTR}:parent`)},m=function({model:t,target:e,config:r,value:n,engine:c}){n?delete e.raycast:e.raycast=t.emptyRaycast},A=l.defineModel.extend({shared:{eventSymbol:"vis.event",emptyRaycast:()=>{}},context(){return{cacheLookAt:{target:null,updateMatrixWorld:null}}},commands:{add:{pointerdown:d,pointerup:d,pointermove:d,pointerenter:d,pointerleave:d,click:d,dblclick:d,contextmenu:d,children:b},set:{lookAt:h,pointerdown:p,pointerup:p,pointermove:p,pointerenter:p,pointerleave:p,click:p,dblclick:p,contextmenu:p,parent:l.emptyHandler,raycast:m,children:{$reg:[{reg:new RegExp(".*"),handler:b}]}},delete:{pointerdown:f,pointerup:f,pointermove:f,pointerenter:f,pointerleave:f,click:f,dblclick:f,contextmenu:f,children:M}},create({model:t,target:e,config:r,engine:n,filter:c}){!c.lookAt&&h.call(t,{model:t,target:e,config:r,value:r.lookAt,engine:n}),!r.raycast&&(e.raycast=t.emptyRaycast),r.children.forEach(o=>{b.call(t,{model:t,target:e,config:r,value:o,engine:n})});for(const o of Object.values(l.EVENTNAME))t.asyncNextTick(()=>(r[o].forEach((i,a)=>{d.call(t,{model:t,target:e,path:[o,a.toString()],value:i,engine:n})}),!0));g.syncObject(r,e,{vid:!0,type:!0,lookAt:!0,parent:!0,children:!0,raycast:!0,pointerdown:!0,pointermove:!0,pointerup:!0,pointerenter:!0,pointerleave:!0,click:!0,dblclick:!0,contextmenu:!0,...c})},dispose({target:t}){t&&(t._listener={})}});u.EventGeneratorManager=v,u.ObjectRule=L,u.defineObjectModel=A,u.getObjectConfig=O,Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});
